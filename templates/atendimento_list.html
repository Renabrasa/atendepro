{% extends 'base.html' %}
{% block title %}Atendimentos{% endblock %}
{% block content %}
<style>
  /* Variáveis Profissionais */
  :root {
    --primary: #1e293b;
    --secondary: #475569;
    --accent: #3b82f6;
    --background: #f8fafc;
    --white: #ffffff;
    --border: #e2e8f0;
    --text: #334155;
    --muted: #64748b;
    --success: #059669;
    --warning: #d97706;
    --danger: #dc2626;
  }

  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
  }

  body {
    background: var(--background);
    color: var(--text);
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    line-height: 1.5;
  }

  .atendimentos {
    max-width: 1400px;
    margin: 0 auto;
    padding: 24px;
  }

  /* Header com KPIs Integrados */
  .header {
    background: var(--white);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 24px 32px;
    margin-bottom: 24px;
  }

  .header-top {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
  }

  .header-content h1 {
    font-size: 24px;
    font-weight: 600;
    color: var(--primary);
    margin-bottom: 4px;
  }

  .header-content p {
    color: var(--muted);
    font-size: 14px;
  }

  .header-actions {
    display: flex;
    gap: 12px;
  }

  .btn {
    padding: 8px 16px;
    border-radius: 6px;
    border: 1px solid var(--border);
    background: var(--white);
    color: var(--text);
    text-decoration: none;
    font-size: 14px;
    font-weight: 500;
    transition: all 0.2s;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    cursor: pointer;
  }

  .btn:hover {
    background: var(--background);
    border-color: var(--accent);
  }

  .btn-primary {
    background: var(--accent);
    color: var(--white);
    border-color: var(--accent);
  }

  .btn-primary:hover {
    background: #2563eb;
  }

  .btn-success {
    background: var(--success);
    color: var(--white);
    border-color: var(--success);
  }

  .btn-success:hover {
    background: #047857;
  }

  .btn-sm {
    padding: 4px 8px;
    font-size: 12px;
  }

  .btn-danger {
    background: var(--danger);
    color: var(--white);
    border-color: var(--danger);
  }

  .btn-danger:hover {
    background: #b91c1c;
  }

  /* KPIs Compactos */
  .kpis {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 24px;
  }

  .kpi {
    text-align: center;
  }

  .kpi-value {
    font-size: 28px;
    font-weight: 700;
    color: var(--primary);
    line-height: 1;
    margin-bottom: 6px;
  }

  .kpi-label {
    font-size: 12px;
    color: var(--muted);
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  /* Filtros Horizontais */
  .filters {
    background: var(--white);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 20px 24px;
    margin-bottom: 24px;
  }

  .filters-row {
    display: grid;
    grid-template-columns: 150px 150px 200px 150px 200px 1fr auto;
    gap: 16px;
    align-items: end;
  }

  .form-group {
    display: flex;
    flex-direction: column;
    gap: 6px;
  }

  .form-label {
    font-size: 12px;
    font-weight: 500;
    color: var(--text);
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .form-input, .form-select {
    padding: 8px 12px;
    border: 1px solid var(--border);
    border-radius: 6px;
    font-size: 14px;
    transition: border-color 0.2s;
    background: var(--white);
  }

  .form-input:focus, .form-select:focus {
    outline: none;
    border-color: var(--accent);
  }

  .form-select {
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
    background-position: right 8px center;
    background-repeat: no-repeat;
    background-size: 16px;
    padding-right: 32px;
    appearance: none;
  }

  .filter-actions {
    display: flex;
    gap: 8px;
  }

  /* Tabela Principal */
  .data-table {
    background: var(--white);
    border: 1px solid var(--border);
    border-radius: 8px;
    overflow: hidden;
    margin-bottom: 24px;
  }

  .table-header {
    padding: 16px 20px;
    border-bottom: 1px solid var(--border);
    background: #fafbfc;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .table-title {
    font-size: 16px;
    font-weight: 600;
    color: var(--primary);
  }

  .table-subtitle {
    font-size: 12px;
    color: var(--muted);
  }

  .table-container {
    height: 500px;
    overflow-y: auto;
  }

  .table {
    width: 100%;
    border-collapse: collapse;
  }

  .table th {
    background: #fafbfc;
    padding: 12px 16px;
    text-align: left;
    font-size: 11px;
    font-weight: 600;
    color: var(--muted);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    border-bottom: 1px solid var(--border);
    position: sticky;
    top: 0;
    z-index: 10;
  }

  .table td {
    padding: 16px;
    border-bottom: 1px solid #f1f5f9;
    font-size: 14px;
    vertical-align: middle;
  }

  .table tr:hover {
    background: #fafbfc;
  }

  .atendimento-id {
    font-weight: 600;
    color: var(--accent);
    font-family: monospace;
  }

  .agente-name {
    font-weight: 600;
    color: var(--primary);
  }

  .supervisor-name {
    color: var(--muted);
    font-size: 13px;
  }

  .conteudo-preview {
    max-width: 300px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    color: var(--text);
    line-height: 1.4;
  }

  .status-badge {
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 11px;
    font-weight: 500;
    text-transform: uppercase;
  }

  .status-pendente {
    background: #fef3c7;
    color: #92400e;
  }

  .status-classificado {
    background: #dcfce7;
    color: #166534;
  }

  .status-concluido {
    background: #dbeafe;
    color: #1d4ed8;
  }

  .classificacao-badge {
    padding: 2px 8px;
    border-radius: 10px;
    font-size: 10px;
    font-weight: 500;
    text-transform: uppercase;
  }

  .classificacao-basico {
    background: #dcfce7;
    color: #166534;
  }

  .classificacao-medio {
    background: #fef3c7;
    color: #92400e;
  }

  .classificacao-complexo {
    background: #fecaca;
    color: #991b1b;
  }

  .classificacao-sem {
    background: #f1f5f9;
    color: var(--muted);
  }

  .actions-cell {
    display: flex;
    gap: 4px;
  }

  .date-cell {
    font-size: 13px;
    color: var(--text);
  }

  .time-cell {
    font-size: 11px;
    color: var(--muted);
    margin-top: 2px;
  }

  /* Paginação Simples */
  .pagination {
    background: var(--white);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 16px 20px;
    display: flex;
    justify-content: between;
    align-items: center;
  }

  .pagination-info {
    font-size: 13px;
    color: var(--muted);
  }

  .pagination-controls {
    display: flex;
    gap: 8px;
    margin-left: auto;
  }

  .pagination-btn {
    padding: 6px 12px;
    border: 1px solid var(--border);
    background: var(--white);
    color: var(--text);
    text-decoration: none;
    border-radius: 6px;
    font-size: 13px;
    transition: all 0.2s;
  }

  .pagination-btn:hover:not(.disabled) {
    background: var(--background);
    border-color: var(--accent);
  }

  .pagination-btn.current {
    background: var(--accent);
    color: var(--white);
    border-color: var(--accent);
  }

  .pagination-btn.disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  /* Estados Vazios */
  .empty-state {
    text-align: center;
    padding: 60px 20px;
    color: var(--muted);
  }

  .empty-state h3 {
    color: var(--text);
    margin-bottom: 8px;
    font-weight: 500;
  }

  /* ===== NOVAS FUNCIONALIDADES: CHECKBOXES E AÇÕES EM LOTE ===== */
  
  /* Estilos para checkboxes */
  .bulk-checkbox, .atendimento-checkbox {
    width: 16px;
    height: 16px;
    cursor: pointer;
    accent-color: var(--accent);
  }
  
  .bulk-checkbox {
    margin: 0;
  }
  
  .atendimento-checkbox {
    margin: 0;
  }
  
  /* Highlight para linhas selecionadas */
  tr.selected {
    background-color: #e0f2fe !important;
    border-left: 3px solid var(--accent);
  }
  
  tr.selected:hover {
    background-color: #b3e5fc !important;
  }

  /* Barra de Ações em Lote */
  .bulk-actions-bar {
    position: fixed;
    bottom: 30px;
    left: 50%;
    transform: translateX(-50%);
    background: var(--white);
    border: 1px solid var(--border);
    border-radius: 12px;
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
    padding: 16px 24px;
    display: none;
    align-items: center;
    gap: 16px;
    z-index: 1000;
    min-width: 400px;
    backdrop-filter: blur(10px);
  }

  .bulk-actions-bar.show {
    display: flex;
    animation: slideUp 0.3s ease-out;
  }

  @keyframes slideUp {
    from {
      opacity: 0;
      transform: translateX(-50%) translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }
  }

  .bulk-counter {
    font-size: 14px;
    font-weight: 600;
    color: var(--accent);
    background: #e0f2fe;
    padding: 6px 12px;
    border-radius: 20px;
    white-space: nowrap;
  }

  .bulk-actions {
    display: flex;
    align-items: center;
    gap: 12px;
    flex: 1;
  }

  .bulk-select {
    padding: 8px 12px;
    border: 1px solid var(--border);
    border-radius: 6px;
    font-size: 14px;
    background: var(--white);
    color: var(--text);
    cursor: pointer;
    transition: border-color 0.2s;
    min-width: 150px;
  }

  .bulk-select:focus {
    outline: none;
    border-color: var(--accent);
  }

  .bulk-apply-btn {
    background: var(--success);
    color: var(--white);
    border: 1px solid var(--success);
    padding: 8px 16px;
    border-radius: 6px;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .bulk-apply-btn:hover:not(:disabled) {
    background: #047857;
    border-color: #047857;
  }

  .bulk-apply-btn:disabled {
    background: var(--muted);
    border-color: var(--muted);
    cursor: not-allowed;
    opacity: 0.6;
  }

  .bulk-cancel-btn {
    background: transparent;
    color: var(--muted);
    border: 1px solid var(--border);
    padding: 8px 16px;
    border-radius: 6px;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.2s;
  }

  .bulk-cancel-btn:hover {
    background: #fee2e2;
    color: var(--danger);
    border-color: var(--danger);
  }

  /* Estados de loading */
  .bulk-apply-btn.loading {
    background: var(--muted);
    border-color: var(--muted);
    cursor: not-allowed;
    position: relative;
  }

  .bulk-apply-btn.loading::after {
    content: '';
    position: absolute;
    width: 16px;
    height: 16px;
    border: 2px solid transparent;
    border-top: 2px solid white;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    left: 50%;
    top: 50%;
    transform: translate(-50%, -50%);
  }

  @keyframes spin {
    0% { transform: translate(-50%, -50%) rotate(0deg); }
    100% { transform: translate(-50%, -50%) rotate(360deg); }
  }

  /* Toast de feedback */
  .toast {
    position: fixed;
    top: 20px;
    right: 20px;
    background: var(--success);
    color: white;
    padding: 12px 20px;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    z-index: 1001;
    display: none;
    animation: toastSlide 0.3s ease-out;
  }

  .toast.error {
    background: var(--danger);
  }

  .toast.show {
    display: block;
  }

  @keyframes toastSlide {
    from {
      opacity: 0;
      transform: translateX(100%);
    }
    to {
      opacity: 1;
      transform: translateX(0);
    }
  }

  /* Indicadores de validação */
  .validation-warning {
    background: #fef3c7;
    color: #92400e;
    padding: 8px 12px;
    border-radius: 6px;
    font-size: 12px;
    margin-bottom: 8px;
    border-left: 3px solid #f59e0b;
  }

  .bulk-info {
    font-size: 12px;
    color: var(--muted);
    margin-top: 4px;
  }

  /* Indicador de página */
  .page-indicator {
    background: #e0f2fe;
    color: var(--accent);
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 11px;
    font-weight: 500;
    margin-left: 8px;
  }

  /* Estados especiais da tabela */
  .table-row-processing {
    opacity: 0.6;
    pointer-events: none;
  }

  .table-row-success {
    background: #dcfce7 !important;
    animation: successFade 2s ease-out;
  }

  @keyframes successFade {
    0% { background: #dcfce7; }
    100% { background: transparent; }
  }

  /* Melhorias de acessibilidade */
  .bulk-actions-bar[aria-hidden="true"] {
    display: none;
  }

  .sr-only {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border: 0;
  }

  /* Responsivo */
  @media (max-width: 1200px) {
    .filters-row {
      grid-template-columns: 1fr 1fr 1fr;
      gap: 12px;
    }
    
    .kpis {
      grid-template-columns: repeat(2, 1fr);
    }
  }

  @media (max-width: 768px) {
    .atendimentos {
      padding: 16px;
    }

    .header-top {
      flex-direction: column;
      gap: 16px;
      text-align: center;
    }

    .filters-row {
      grid-template-columns: 1fr;
    }

    .kpis {
      grid-template-columns: repeat(2, 1fr);
      gap: 16px;
    }

    .table-container {
      height: 400px;
    }

    .table {
      font-size: 13px;
    }

    .table th,
    .table td {
      padding: 8px;
    }

    .conteudo-preview {
      max-width: 150px;
    }
  }

  /* Melhorias de Performance */
  .table-container::-webkit-scrollbar {
    width: 8px;
  }

  .table-container::-webkit-scrollbar-track {
    background: #f1f5f9;
  }

  .table-container::-webkit-scrollbar-thumb {
    background: #cbd5e0;
    border-radius: 4px;
  }

  .table-container::-webkit-scrollbar-thumb:hover {
    background: #a0aec0;
  }
</style>

<div class="atendimentos">
  <!-- Header com KPIs -->
  <header class="header">
    <div class="header-top">
      <div class="header-content">
        <h1>Atendimentos</h1>
        <p>Gerenciamento e acompanhamento de todos os atendimentos</p>
      </div>
      <div class="header-actions">
        <a href="{{ url_for('novo_atendimento') }}" class="btn btn-primary">
          Novo Atendimento
        </a>
        <a href="{{ url_for('dashboard') }}" class="btn">
          Dashboard
        </a>
      </div>
    </div>

    <!-- KPIs Integrados -->
    <div class="kpis">
      <div class="kpi">
        <div class="kpi-value">{{ stats.total_filtrados }}</div>
        <div class="kpi-label">Total Encontrados</div>
      </div>
      <div class="kpi">
        <div class="kpi-value">{{ stats.pendentes }}</div>
        <div class="kpi-label">Pendentes</div>
      </div>
      <div class="kpi">
        <div class="kpi-value">{{ stats.classificados }}</div>
        <div class="kpi-label">Classificados</div>
      </div>
      <div class="kpi">
        <div class="kpi-value">{{ stats.hoje }}</div>
        <div class="kpi-label">Hoje</div>
      </div>
    </div>
  </header>

  <!-- Filtros Horizontais -->
  <section class="filters">
    <form method="GET" class="filters-row">
      <div class="form-group">
        <label class="form-label">Data Inicial</label>
        <input type="date" name="data_inicio" value="{{ current_filters.data_inicio }}" class="form-input">
      </div>
      
      <div class="form-group">
        <label class="form-label">Data Final</label>
        <input type="date" name="data_fim" value="{{ current_filters.data_fim }}" class="form-input">
      </div>
      
      <div class="form-group">
        <label class="form-label">Agente</label>
        <select name="agente" class="form-select">
          <option value="">Todos os agentes</option>
          {% for agente in agentes_dropdown %}
            <option value="{{ agente.id }}" {{ 'selected' if current_filters.agente == agente.id|string }}>
              {{ agente.nome }}
            </option>
          {% endfor %}
        </select>
      </div>

      <div class="form-group">
        <label class="form-label">Status</label>
        <select name="status" class="form-select">
          <option value="">Todos</option>
          <option value="pendente" {{ 'selected' if current_filters.status == 'pendente' }}>Pendente</option>
          <option value="classificado" {{ 'selected' if current_filters.status == 'classificado' }}>Classificado</option>
        </select>
      </div>
      
      <div class="form-group">
        <label class="form-label">Atendido Por</label>
        <select name="atendido_por" class="form-select">
          <option value="">Todos</option>
          {% for supervisor in supervisores_dropdown %}
            <option value="{{ supervisor.id }}" {{ 'selected' if current_filters.atendido_por == supervisor.id|string }}>
              {{ supervisor.nome }}
            </option>
          {% endfor %}
        </select>
      </div>
      
      <div class="form-group">
        <label class="form-label">Buscar</label>
        <input type="text" name="busca" placeholder="Conteúdo..." value="{{ current_filters.busca }}" class="form-input">
      </div>
      
      <div class="filter-actions">
        <button type="submit" class="btn btn-success">Filtrar</button>
        <a href="{{ url_for('limpar_filtros') }}" style="color: #6b7280; text-decoration: underline; font-size: 13px; margin-left: 16px;" title="Limpa todos os filtros">
          limpar filtros
        </a>
      </div>
    </form>
  </section>

  <!-- Tabela Principal -->
  <section class="data-table">
    <div class="table-header">
      <div>
        <div class="table-title">Lista de Atendimentos</div>
        <div class="table-subtitle">
          Mostrando {{ atendimentos_paginated.per_page * (atendimentos_paginated.page - 1) + 1 }} 
          a {{ atendimentos_paginated.per_page * (atendimentos_paginated.page - 1) + atendimentos|length }} 
          de {{ atendimentos_paginated.total }} atendimentos
        </div>
      </div>
    </div>
    
    <div class="table-container">
      <table class="table">
        <thead>
          <tr>
            <!-- NOVA COLUNA: Checkbox Selecionar Todos -->
            <th style="width: 50px;">
              <input type="checkbox" id="selectAll" class="bulk-checkbox" title="Selecionar todos">
            </th>
            <th style="width: 80px;">ID</th>
            <th style="width: 120px;">Data/Hora</th>
            <th style="width: 150px;">Agente</th>
            <th style="width: 130px;">Atendido Por</th>
            <th>Conteúdo</th>
            <th style="width: 100px;">Classificação</th>
            <th style="width: 100px;">Status</th>
            <th style="width: 120px;">Ações</th>
          </tr>
        </thead>
        <tbody>
          {% for atendimento in atendimentos %}
            <tr>
              <!-- NOVA COLUNA: Checkbox Individual -->
              <td>
                <input type="checkbox" 
                       class="atendimento-checkbox" 
                       value="{{ atendimento.id }}"
                       data-agente="{{ atendimento.agente_rel.nome if atendimento.agente_rel else 'N/A' }}"
                       data-status="{{ atendimento.status or 'pendente' }}"
                       data-classificacao="{{ atendimento.classificacao or '' }}">
              </td>
              
              <td>
                <span class="atendimento-id">#{{ atendimento.id }}</span>
              </td>
              <td>
                <div class="date-cell">{{ atendimento.data_hora.strftime('%d/%m/%Y') }}</div>
                <div class="time-cell">{{ atendimento.data_hora.strftime('%H:%M') }}</div>
              </td>
              <td>
                <div class="agente-name">{{ atendimento.agente_rel.nome }}</div>
              </td>
              <td>
                <div class="supervisor-name">{{ atendimento.supervisor.nome }}</div>
                {% if atendimento.supervisor.tipo == 'coordenadora' %}
                  <div style="font-size: 10px; color: var(--accent); font-weight: 600;">COORDENADORA</div>
                {% endif %}
              </td>
              <td>
                <div class="conteudo-preview" title="{{ atendimento.conteudo }}">
                  {{ atendimento.conteudo }}
                </div>
              </td>
              <td>
                {% if atendimento.classificacao %}
                  <span class="classificacao-badge classificacao-{{ atendimento.classificacao }}">
                    {{ atendimento.classificacao }}
                  </span>
                {% else %}
                  <span class="classificacao-badge classificacao-sem">—</span>
                {% endif %}
              </td>
              <td>
                <span class="status-badge status-{{ atendimento.status or 'pendente' }}">
                  {{ atendimento.status or 'pendente' }}
                </span>
              </td>
              <td>
                <div class="actions-cell">
                  <a href="{{ url_for('editar_atendimento', atendimento_id=atendimento.id) }}" 
                     class="btn btn-sm" title="Editar">
                    Editar
                  </a>
                  <a href="{{ url_for('excluir_atendimento', atendimento_id=atendimento.id) }}" 
                     onclick="return confirm('Confirma exclusão do atendimento #{{ atendimento.id }}?');" 
                     class="btn btn-sm btn-danger" title="Excluir">
                    Excluir
                  </a>
                </div>
              </td>
            </tr>
          {% else %}
            <tr>
              <td colspan="9" class="empty-state">
                <h3>Nenhum atendimento encontrado</h3>
                <p>Não há atendimentos para os critérios selecionados.</p>
                <a href="{{ url_for('novo_atendimento') }}" class="btn btn-primary" style="margin-top: 16px;">
                  Criar Primeiro Atendimento
                </a>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </section>

  <!-- Barra de Ações em Lote (Inicialmente Oculta) -->
  <div id="bulkActionsBar" class="bulk-actions-bar" aria-hidden="true">
    <div class="bulk-counter" id="bulkCounter">
      0 selecionados
      <span class="page-indicator" id="pageIndicator" style="display: none;">
        Página {{ atendimentos_paginated.page }}
      </span>
    </div>
    
    <div class="bulk-actions">
      <!-- Warnings de validação -->
      <div id="validationWarnings" style="display: none;">
        <div class="validation-warning" id="permissionWarning" style="display: none;">
          ⚠️ Alguns atendimentos selecionados não podem ser editados
        </div>
        <div class="validation-warning" id="pageWarning" style="display: none;">
          💡 Seleções em outras páginas serão perdidas
        </div>
      </div>
      
      <label for="bulkClassification" style="font-size: 14px; font-weight: 500; color: var(--text); white-space: nowrap;">
        Classificar como:
      </label>
      
      <select id="bulkClassification" class="bulk-select" aria-describedby="bulkInfo">
        <option value="">Selecione uma classificação</option>
        <option value="básico">🟢 Básico</option>
        <option value="médio">🟡 Médio</option>
        <option value="complexo">🔴 Complexo</option>
        <option value="">🔄 Não Definido</option>
      </select>
      
      <div class="bulk-info" id="bulkInfo">
        Apenas atendimentos que você pode editar serão atualizados
      </div>
      
      <button id="bulkApplyBtn" class="bulk-apply-btn" disabled aria-describedby="bulkCounter">
        ✅ Aplicar
        <span class="sr-only" id="applyButtonText">classificação aos atendimentos selecionados</span>
      </button>
      
      <button id="bulkCancelBtn" class="bulk-cancel-btn">
        ❌ Cancelar
        <span class="sr-only">seleção</span>
      </button>
    </div>
  </div>

  <!-- Toast para feedback -->
  <div id="toast" class="toast"></div>

  <!-- Paginação Simples -->
  {% if atendimentos_paginated.pages > 1 %}
  <nav class="pagination">
    <div class="pagination-info">
      Página {{ atendimentos_paginated.page }} de {{ atendimentos_paginated.pages }}
    </div>
    
    <div class="pagination-controls">
      {% if atendimentos_paginated.has_prev %}
        <a href="{{ url_for('atendimentos', page=1, **current_filters) }}" class="pagination-btn">
          Primeira
        </a>
        <a href="{{ url_for('atendimentos', page=atendimentos_paginated.prev_num, **current_filters) }}" class="pagination-btn">
          Anterior
        </a>
      {% else %}
        <span class="pagination-btn disabled">Primeira</span>
        <span class="pagination-btn disabled">Anterior</span>
      {% endif %}

      {% for page_num in atendimentos_paginated.iter_pages(left_edge=1, right_edge=1, left_current=1, right_current=1) %}
        {% if page_num %}
          {% if page_num != atendimentos_paginated.page %}
            <a href="{{ url_for('atendimentos', page=page_num, **current_filters) }}" class="pagination-btn">{{ page_num }}</a>
          {% else %}
            <span class="pagination-btn current">{{ page_num }}</span>
          {% endif %}
        {% else %}
          <span class="pagination-btn disabled">…</span>
        {% endif %}
      {% endfor %}

      {% if atendimentos_paginated.has_next %}
        <a href="{{ url_for('atendimentos', page=atendimentos_paginated.next_num, **current_filters) }}" class="pagination-btn">
          Próxima
        </a>
        <a href="{{ url_for('atendimentos', page=atendimentos_paginated.pages, **current_filters) }}" class="pagination-btn">
          Última
        </a>
      {% else %}
        <span class="pagination-btn disabled">Próxima</span>
        <span class="pagination-btn disabled">Última</span>
      {% endif %}
    </div>
  </nav>
  {% endif %}
</div>

<script>
  // ===== FUNCIONALIDADES ORIGINAIS MANTIDAS =====
  
  // Validação de filtros
  document.querySelector('form').addEventListener('submit', function(e) {
    const inicio = document.querySelector('[name="data_inicio"]').value;
    const fim = document.querySelector('[name="data_fim"]').value;
    
    if (inicio && fim && inicio > fim) {
      e.preventDefault();
      alert('A data inicial não pode ser maior que a data final.');
    }
  });

  // Auto-submit em mudanças de select (opcional)
  document.querySelectorAll('.form-select').forEach(select => {
    select.addEventListener('change', function() {
      // Se quiser auto-submit, descomente a linha abaixo
      // this.form.submit();
    });
  });

  // Confirmar exclusões
  document.addEventListener('click', function(e) {
    if (e.target.textContent === 'Excluir' && e.target.classList.contains('btn-danger')) {
      if (!confirm('Tem certeza que deseja excluir este atendimento?')) {
        e.preventDefault();
      }
    }
  });

  // ===== NOVAS FUNCIONALIDADES: CHECKBOXES =====
  
  // JavaScript para gerenciar checkboxes
  const selectAllCheckbox = document.getElementById('selectAll');
  const atendimentoCheckboxes = document.querySelectorAll('.atendimento-checkbox');

  // Função para selecionar/deselecionar todos
  selectAllCheckbox.addEventListener('change', function() {
    const isChecked = this.checked;
    
    atendimentoCheckboxes.forEach(checkbox => {
      checkbox.checked = isChecked;
      // Aplicar highlight visual
      const row = checkbox.closest('tr');
      if (isChecked) {
        row.classList.add('selected');
      } else {
        row.classList.remove('selected');
      }
    });
    
    updateSelectedCount();
  });

  // Função para gerenciar seleção individual
  atendimentoCheckboxes.forEach(checkbox => {
    checkbox.addEventListener('change', function() {
      const row = this.closest('tr');
      
      // Aplicar highlight visual
      if (this.checked) {
        row.classList.add('selected');
      } else {
        row.classList.remove('selected');
      }
      
      // Atualizar estado do "Selecionar Todos"
      const totalCheckboxes = atendimentoCheckboxes.length;
      const checkedCheckboxes = document.querySelectorAll('.atendimento-checkbox:checked').length;
      
      if (checkedCheckboxes === 0) {
        selectAllCheckbox.indeterminate = false;
        selectAllCheckbox.checked = false;
      } else if (checkedCheckboxes === totalCheckboxes) {
        selectAllCheckbox.indeterminate = false;
        selectAllCheckbox.checked = true;
      } else {
        selectAllCheckbox.indeterminate = true;
        selectAllCheckbox.checked = false;
      }
      
      updateSelectedCount();
    });
  });

  // Função para atualizar contador de selecionados
  function updateSelectedCount() {
    const checkedCheckboxes = document.querySelectorAll('.atendimento-checkbox:checked');
    const checkedCount = checkedCheckboxes.length;
    
    // Elementos da barra de ações
    const bulkActionsBar = document.getElementById('bulkActionsBar');
    const bulkCounter = document.getElementById('bulkCounter');
    const bulkApplyBtn = document.getElementById('bulkApplyBtn');
    const bulkClassification = document.getElementById('bulkClassification');
    const pageIndicator = document.getElementById('pageIndicator');
    const validationWarnings = document.getElementById('validationWarnings');
    const permissionWarning = document.getElementById('permissionWarning');
    
    // Atualizar contador e mostrar/ocultar barra
    if (checkedCount > 0) {
      bulkCounter.innerHTML = `${checkedCount} selecionado${checkedCount > 1 ? 's' : ''}`;
      
      // Mostrar indicador de página se há seleções
      if (pageIndicator) {
        pageIndicator.style.display = 'inline';
        bulkCounter.appendChild(pageIndicator);
      }
      
      bulkActionsBar.classList.add('show');
      bulkActionsBar.setAttribute('aria-hidden', 'false');
      
      // Validar permissões dos atendimentos selecionados
      validateSelectedPermissions(checkedCheckboxes);
      
      // Habilitar/desabilitar botão aplicar
      const hasValidClassification = bulkClassification.value !== undefined;
      bulkApplyBtn.disabled = !hasValidClassification;
      
    } else {
      bulkActionsBar.classList.remove('show');
      bulkActionsBar.setAttribute('aria-hidden', 'true');
      pageIndicator.style.display = 'none';
      validationWarnings.style.display = 'none';
      
      // Reset da seleção quando não há itens selecionados
      bulkClassification.value = '';
    }
    
    console.log(`${checkedCount} atendimentos selecionados`);
  }

  // Função para validar permissões dos itens selecionados
  function validateSelectedPermissions(checkedCheckboxes) {
    const validationWarnings = document.getElementById('validationWarnings');
    const permissionWarning = document.getElementById('permissionWarning');
    const currentUserType = '{{ current_user.tipo }}';
    const currentUserId = {{ current_user.id }};
    
    let hasPermissionIssues = false;
    
    // Para admin e coordenadora, todas as permissões são válidas
    if (currentUserType === 'admin' || currentUserType === 'coordenadora') {
      validationWarnings.style.display = 'none';
      return;
    }
    
    // Para supervisores, verificar se todos os atendimentos são seus
    checkedCheckboxes.forEach(checkbox => {
      const row = checkbox.closest('tr');
      const supervisorCell = row.querySelector('.supervisor-name');
      // Aqui seria ideal ter um data-attribute com o ID do supervisor
      // Por simplicidade, vamos assumir que se não é admin/coordenadora,
      // pode haver restrições
      if (currentUserType === 'supervisor') {
        hasPermissionIssues = true; // Simplificado para exemplo
      }
    });
    
    if (hasPermissionIssues) {
      validationWarnings.style.display = 'block';
      permissionWarning.style.display = 'block';
    } else {
      validationWarnings.style.display = 'none';
    }
  }

  // Event listeners para a barra de ações em lote
  document.addEventListener('DOMContentLoaded', function() {
    const bulkClassification = document.getElementById('bulkClassification');
    const bulkApplyBtn = document.getElementById('bulkApplyBtn');
    const bulkCancelBtn = document.getElementById('bulkCancelBtn');
    
    // Habilitar botão aplicar quando classificação é selecionada
    bulkClassification.addEventListener('change', function() {
      const hasSelection = document.querySelectorAll('.atendimento-checkbox:checked').length > 0;
      bulkApplyBtn.disabled = !hasSelection;
    });
    
    // Botão aplicar classificação
    bulkApplyBtn.addEventListener('click', async function() {
      // Prevenção de cliques duplos
      if (this.classList.contains('loading')) {
        return;
      }

      const selectedCheckboxes = document.querySelectorAll('.atendimento-checkbox:checked');
      const selectedIds = Array.from(selectedCheckboxes).map(checkbox => checkbox.value);
      const classification = bulkClassification.value;
      
      // Validações aprimoradas
      if (selectedIds.length === 0) {
        showToast('Nenhum atendimento selecionado.', 'error');
        return;
      }

      if (selectedIds.length > 50) {
        if (!confirm('Você está prestes a classificar mais de 50 atendimentos. Isso pode demorar alguns segundos. Deseja continuar?')) {
          return;
        }
      }
      
      const classificationText = classification === 'básico' ? 'Básico' :
                                classification === 'médio' ? 'Médio' :
                                classification === 'complexo' ? 'Complexo' : 'Não Definido';
      
      // Confirmação com detalhes
      const confirmMessage = `Confirma a classificação de ${selectedIds.length} atendimento(s) como "${classificationText}"?\n\n` +
                           `Esta ação irá:\n` +
                           `• Alterar a classificação dos atendimentos selecionados\n` +
                           `• Atualizar o status para "${classification ? 'classificado' : 'pendente'}"\n` +
                           `• Esta ação não pode ser desfeita em lote`;
      
      if (!confirm(confirmMessage)) {
        return;
      }

      // Marcar linhas como em processamento
      selectedCheckboxes.forEach(checkbox => {
        checkbox.closest('tr').classList.add('table-row-processing');
      });

      // Estado de loading aprimorado
      setLoadingState(true);
      
      try {
        // Fazer requisição para o backend
        const response = await fetch('{{ url_for("classificar_atendimentos_lote") }}', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': getCSRFToken() // Adicionar CSRF se necessário
          },
          body: JSON.stringify({
            atendimento_ids: selectedIds,
            classificacao: classification
          })
        });

        const result = await response.json();

        if (response.ok && result.success) {
          // Sucesso - feedback aprimorado
          const successMessage = `✅ ${result.atendimentos_atualizados} de ${selectedIds.length} atendimento(s) classificado(s) com sucesso!`;
          showToast(successMessage, 'success');
          
          // Marcar linhas como sucesso antes de atualizar
          selectedCheckboxes.forEach(checkbox => {
            const row = checkbox.closest('tr');
            row.classList.remove('table-row-processing');
            row.classList.add('table-row-success');
          });
          
          // Atualizar os badges de classificação na tabela
          updateClassificationBadges(selectedIds, classification);
          
          // Log para analytics/debug
          console.log('Classificação em lote bem-sucedida:', {
            totalSelecionados: selectedIds.length,
            totalAtualizados: result.atendimentos_atualizados,
            classificacao: classification,
            timestamp: new Date().toISOString()
          });
          
          // Limpar seleções após 2 segundos
          setTimeout(() => {
            clearAllSelections();
            // Remover classes de sucesso
            document.querySelectorAll('.table-row-success').forEach(row => {
              row.classList.remove('table-row-success');
            });
          }, 2000);
          
        } else {
          // Erro do servidor com detalhes
          const errorMessage = result.message || 'Erro interno do servidor';
          showToast(`❌ Erro: ${errorMessage}`, 'error');
          
          // Remover estado de processamento
          selectedCheckboxes.forEach(checkbox => {
            checkbox.closest('tr').classList.remove('table-row-processing');
          });
          
          console.error('Erro na classificação em lote:', result);
        }
        
      } catch (error) {
        console.error('Erro na requisição:', error);
        showToast('❌ Erro de conexão. Verifique sua internet e tente novamente.', 'error');
        
        // Remover estado de processamento
        selectedCheckboxes.forEach(checkbox => {
          checkbox.closest('tr').classList.remove('table-row-processing');
        });
      } finally {
        // Sempre remover estado de loading
        setLoadingState(false);
      }
    });
    
    // Botão cancelar seleção
    bulkCancelBtn.addEventListener('click', function() {
      clearAllSelections();
    });
  });

  // Funções auxiliares aprimoradas
  function showToast(message, type = 'success') {
    const toast = document.getElementById('toast');
    toast.textContent = message;
    toast.className = `toast ${type} show`;
    
    // Auto-hide com timing baseado no tipo
    const hideDelay = type === 'error' ? 6000 : 4000;
    setTimeout(() => {
      toast.classList.remove('show');
    }, hideDelay);
    
    // Log para debug
    console.log(`Toast ${type}:`, message);
  }

  function setLoadingState(isLoading) {
    const bulkApplyBtn = document.getElementById('bulkApplyBtn');
    const bulkCancelBtn = document.getElementById('bulkCancelBtn');
    const bulkClassification = document.getElementById('bulkClassification');
    
    if (isLoading) {
      bulkApplyBtn.disabled = true;
      bulkApplyBtn.classList.add('loading');
      bulkApplyBtn.innerHTML = '⏳ Processando...';
      bulkCancelBtn.disabled = true;
      bulkClassification.disabled = true;
    } else {
      bulkApplyBtn.disabled = false;
      bulkApplyBtn.classList.remove('loading');
      bulkApplyBtn.innerHTML = '✅ Aplicar<span class="sr-only" id="applyButtonText">classificação aos atendimentos selecionados</span>';
      bulkCancelBtn.disabled = false;
      bulkClassification.disabled = false;
    }
  }

  function clearAllSelections() {
    // Desmarcar todos os checkboxes
    document.querySelectorAll('.atendimento-checkbox:checked').forEach(checkbox => {
      checkbox.checked = false;
      const row = checkbox.closest('tr');
      row.classList.remove('selected', 'table-row-processing', 'table-row-success');
    });
    
    // Reset checkbox principal
    const selectAllCheckbox = document.getElementById('selectAll');
    if (selectAllCheckbox) {
      selectAllCheckbox.checked = false;
      selectAllCheckbox.indeterminate = false;
    }
    
    // Reset seleção de classificação
    document.getElementById('bulkClassification').value = '';
    
    // Atualizar contador (vai ocultar a barra)
    updateSelectedCount();
    
    console.log('Todas as seleções foram limpas');
  }

  function updateClassificationBadges(selectedIds, newClassification) {
    let updatedCount = 0;
    
    selectedIds.forEach(id => {
      const checkbox = document.querySelector(`.atendimento-checkbox[value="${id}"]`);
      if (checkbox) {
        const row = checkbox.closest('tr');
        const badgeCell = row.querySelector('.classificacao-badge');
        
        if (badgeCell) {
          // Remover classes antigas
          badgeCell.className = 'classificacao-badge';
          
          // Aplicar nova classificação
          if (newClassification === 'básico') {
            badgeCell.className += ' classificacao-basico';
            badgeCell.textContent = 'básico';
          } else if (newClassification === 'médio') {
            badgeCell.className += ' classificacao-medio';
            badgeCell.textContent = 'médio';
          } else if (newClassification === 'complexo') {
            badgeCell.className += ' classificacao-complexo';
            badgeCell.textContent = 'complexo';
          } else {
            badgeCell.className += ' classificacao-sem';
            badgeCell.textContent = '—';
          }
          
          updatedCount++;
        }
      }
    });
    
    console.log(`${updatedCount} badges de classificação atualizados na interface`);
  }

  // Função para obter CSRF token se necessário
  function getCSRFToken() {
    const token = document.querySelector('meta[name="csrf-token"]');
    return token ? token.getAttribute('content') : '';
  }

  // Função para detectar mudanças de página e avisar sobre seleções perdidas
  function detectPageChange() {
    const paginationLinks = document.querySelectorAll('.pagination-btn');
    paginationLinks.forEach(link => {
      link.addEventListener('click', function(e) {
        const checkedCount = document.querySelectorAll('.atendimento-checkbox:checked').length;
        if (checkedCount > 0) {
          if (!confirm(`Você tem ${checkedCount} atendimento(s) selecionado(s). Ao mudar de página, essas seleções serão perdidas. Deseja continuar?`)) {
            e.preventDefault();
          }
        }
      });
    });
  }

  // Inicializar detecção de mudança de página
  document.addEventListener('DOMContentLoaded', function() {
    detectPageChange();
  });

  // Log para debug
  console.log('✅ Checkboxes configurados!', {
    total: atendimentoCheckboxes.length,
    selectAll: !!selectAllCheckbox
  });
</script>

{% endblock %}