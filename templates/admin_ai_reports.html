{% extends 'base.html' %}
{% block title %}AI Reports - Painel Admin{% endblock %}

{% block head %}
<style>
    .status-card {
        border-left: 4px solid #ddd;
        padding: 15px;
        margin-bottom: 15px;
        border-radius: 0 8px 8px 0;
    }
    .status-success { border-left-color: #28a745; background-color: #f8fff8; }
    .status-warning { border-left-color: #ffc107; background-color: #fffdf7; }
    .status-danger { border-left-color: #dc3545; background-color: #fff8f8; }
    
    .test-section {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
    }
    
    .btn-test {
        margin-right: 10px;
        margin-bottom: 10px;
    }
    
    .result-box {
        background: #ffffff;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        padding: 15px;
        margin-top: 15px;
        max-height: 300px;
        overflow-y: auto;
    }
</style>
{% endblock %}

{% block content %}
<div class="content-wrapper">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>ü§ñ AI Reports - Painel Administrativo</h1>
        <a href="{{ url_for('admin_panel') }}" class="btn btn-secondary">
            ‚Üê Voltar ao Admin
        </a>
    </div>

    <!-- Status do Sistema -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="status-card {% if scheduler_status.enabled %}status-success{% else %}status-warning{% endif %}">
                <h5>‚è∞ Scheduler</h5>
                <p class="mb-1">
                    <strong>Status:</strong> 
                    {% if scheduler_status.enabled %}
                        ‚úÖ Habilitado
                    {% else %}
                        ‚ö†Ô∏è Desabilitado
                    {% endif %}
                </p>
                {% if scheduler_status.next_execution_formatted %}
                <p class="mb-0"><small>Pr√≥xima execu√ß√£o: {{ scheduler_status.next_execution_formatted }}</small></p>
                {% endif %}
            </div>
        </div>
        
        <div class="col-md-4">
            <div class="status-card {% if ollama_status.success %}status-success{% else %}status-danger{% endif %}">
                <h5>üß† Ollama IA</h5>
                <p class="mb-1">
                    <strong>Status:</strong> 
                    {% if ollama_status.success %}
                        ‚úÖ Conectado
                    {% else %}
                        ‚ùå Desconectado
                    {% endif %}
                </p>
                {% if ollama_status.success %}
                <p class="mb-0"><small>Modelo: {{ ollama_status.target_model }}</small></p>
                {% endif %}
            </div>
        </div>
        
        <div class="col-md-4">
            <div class="status-card {% if smtp_status.success %}status-success{% else %}status-danger{% endif %}">
                <h5>üìß SMTP Email</h5>
                <p class="mb-1">
                    <strong>Status:</strong> 
                    {% if smtp_status.success %}
                        ‚úÖ Conectado
                    {% else %}
                        ‚ùå Erro de conex√£o
                    {% endif %}
                </p>
                {% if smtp_status.success %}
                <p class="mb-0"><small>Servidor: {{ smtp_status.smtp_server }}</small></p>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Informa√ß√µes Gerais -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">üìä Informa√ß√µes do Sistema</h5>
                    <div class="row">
                        <div class="col-md-3">
                            <strong>Supervisores cadastrados:</strong><br>
                            <span class="h4 text-primary">{{ supervisors_count }}</span>
                        </div>
                        <div class="col-md-3">
                            <strong>Agendamento:</strong><br>
                            {% if scheduler_status.enabled %}
                                Segundas √†s {{ scheduler_status.hour }}h
                            {% else %}
                                Desabilitado
                            {% endif %}
                        </div>
                        <div class="col-md-3">
                            <strong>Timezone:</strong><br>
                            {{ scheduler_status.timezone }}
                        </div>
                        <div class="col-md-3">
                            <strong>Status geral:</strong><br>
                            {% if ollama_status.success and smtp_status.success %}
                                <span class="text-success">‚úÖ Operacional</span>
                            {% else %}
                                <span class="text-danger">‚ùå Problemas detectados</span>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Testes do Sistema -->
    <div class="test-section">
        <h4>üß™ Testes do Sistema</h4>
        <p class="text-muted">Execute testes para validar o funcionamento do sistema AI Reports</p>
        
        <div class="row">
            <div class="col-md-6">
                <h6>Teste Completo (sem envio de emails)</h6>
                <p><small>Executa todo o fluxo: coleta ‚Üí IA ‚Üí prepara√ß√£o de emails</small></p>
                <button type="button" class="btn btn-primary btn-test" onclick="executeTest(false)">
                    üîÑ Executar Teste Simulado
                </button>
            </div>
            
            <div class="col-md-6">
                <h6>Teste com Envio Real</h6>
                <p><small class="text-warning">‚ö†Ô∏è Enviar√° emails reais para todos os supervisores!</small></p>
                <button type="button" class="btn btn-warning btn-test" onclick="executeTest(true)">
                    üìß Executar Teste REAL
                </button>
            </div>
        </div>
        
        <!-- Resultado dos testes -->
        <div id="testResult" class="result-box" style="display: none;">
            <h6>üìã Resultado do Teste</h6>
            <div id="testContent"></div>
        </div>
        
        <!-- Loading -->
        <div id="testLoading" class="text-center" style="display: none;">
            <div class="spinner-border text-primary" role="status">
                <span class="sr-only">Executando teste...</span>
            </div>
            <p class="mt-2">Executando teste... isso pode levar alguns minutos.</p>
        </div>
    </div>

    <!-- Controle do Scheduler -->
    {% if scheduler_status.enabled %}
    <div class="test-section">
        <h4>‚è∞ Controle do Scheduler</h4>
        <p class="text-muted">Controle manual do agendamento autom√°tico</p>
        
        <div class="row">
            <div class="col-md-6">
                <h6>Status Atual</h6>
                <p>
                    Scheduler: <strong>{% if scheduler_status.running %}üü¢ Rodando{% else %}üî¥ Parado{% endif %}</strong><br>
                    {% if scheduler_status.next_execution_formatted %}
                    Pr√≥xima execu√ß√£o: <strong>{{ scheduler_status.next_execution_formatted }}</strong>
                    {% endif %}
                </p>
            </div>
            
            <div class="col-md-6">
                <h6>Controles</h6>
                {% if scheduler_status.running %}
                    <button type="button" class="btn btn-danger btn-test" onclick="toggleScheduler('stop')">
                        ‚èπÔ∏è Parar Scheduler
                    </button>
                {% else %}
                    <button type="button" class="btn btn-success btn-test" onclick="toggleScheduler('start')">
                        ‚ñ∂Ô∏è Iniciar Scheduler
                    </button>
                {% endif %}
            </div>
        </div>
    </div>
    {% endif %}
</div>

<script>
function executeTest(sendEmails) {
    const testResult = document.getElementById('testResult');
    const testContent = document.getElementById('testContent');
    const testLoading = document.getElementById('testLoading');
    
    // Mostrar loading
    testResult.style.display = 'none';
    testLoading.style.display = 'block';
    
    // Preparar dados
    const formData = new FormData();
    formData.append('send_emails', sendEmails ? 'true' : 'false');
    
    fetch('/admin/ai-reports/test-execution', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        testLoading.style.display = 'none';
        testResult.style.display = 'block';
        
        if (data.success) {
            const action = data.action === 'test_with_emails' ? 'TESTE REAL' : 'TESTE SIMULADO';
            testContent.innerHTML = `
                <div class="alert alert-success">
                    <h6>‚úÖ ${action} CONCLU√çDO COM SUCESSO!</h6>
                    <hr>
                    <strong>üìä Resultados:</strong><br>
                    ‚Ä¢ Per√≠odo analisado: ${data.period}<br>
                    ‚Ä¢ Supervisores analisados: ${data.supervisors_analyzed}<br>
                    ‚Ä¢ Total de atendimentos: ${data.total_tickets}<br>
                    ‚Ä¢ Insights gerados: ${data.insights_generated}<br>
                    ${data.emails_sent !== undefined ? 
                        `‚Ä¢ Emails enviados: ${data.emails_sent}<br>‚Ä¢ Falhas de email: ${data.email_failures}` :
                        `‚Ä¢ Emails preparados: ${data.emails_prepared}`
                    }
                </div>
            `;
        } else {
            testContent.innerHTML = `
                <div class="alert alert-danger">
                    <h6>‚ùå ERRO NO TESTE</h6>
                    <p>${data.error}</p>
                </div>
            `;
        }
    })
    .catch(error => {
        testLoading.style.display = 'none';
        testResult.style.display = 'block';
        testContent.innerHTML = `
            <div class="alert alert-danger">
                <h6>‚ùå ERRO DE CONEX√ÉO</h6>
                <p>${error.message}</p>
            </div>
        `;
    });
}

function toggleScheduler(action) {
    const formData = new FormData();
    formData.append('action', action);
    
    fetch('/admin/ai-reports/toggle-scheduler', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(`‚úÖ ${data.message}`);
            location.reload();
        } else {
            alert(`‚ùå Erro: ${data.error}`);
        }
    })
    .catch(error => {
        alert(`‚ùå Erro de conex√£o: ${error.message}`);
    });
}
</script>
{% endblock %}