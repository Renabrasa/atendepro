# ai_reports/ai_prompts.py
"""
üî§ AI Prompts - Prompts Estruturados para An√°lise IA
Cole√ß√£o de prompts especializados para diferentes tipos de an√°lise
"""

from typing import Dict, List, Any, Optional
from datetime import datetime


class PromptBuilder:
    """
    üî§ Construtor de prompts especializados para an√°lise IA
    
    Gera prompts para an√°lise de produtividade e demanda de atendimentos em contabilidade
    """
    
    @staticmethod
    def global_trend_analysis(global_stats: Dict[str, Any], weekly_data: Dict[str, Any]) -> str:
        """
        üåç Prompt para an√°lise de tend√™ncias globais
        """
        current_tickets = global_stats['current_week']['total_tickets']
        previous_tickets = global_stats['previous_week']['total_tickets']
        change = global_stats['comparison']['absolute_change']
        change_percent = global_stats['comparison']['percent_change']
        active_supervisors = global_stats['current_week']['active_supervisors']
        period = weekly_data['metadata']['current_week']['period_label']
        
        prompt = f"""
Voc√™ √© um analista de produtividade de empresa de contabilidade.

DADOS REAIS DO SISTEMA:
- Per√≠odo atual: {period}
- Total de atendimentos prestados por supervisores: {current_tickets}
- Per√≠odo anterior: {previous_tickets} atendimentos
- Varia√ß√£o real: {change:+d} atendimentos ({change_percent:+.1f}%)
- Supervisores ativos: {active_supervisors}

CONTEXTO:
- Cada atendimento = supervisor ajudou agente/funcion√°rio com caso complexo
- Aumento = agentes precisaram mais suporte (poss√≠vel sobrecarga ou casos complexos)
- Redu√ß√£o = agentes mais aut√¥nomos ou menor demanda de clientes

AN√ÅLISE SOLICITADA:

1. INTERPRETA√á√ÉO DOS N√öMEROS REAIS
   - {change_percent:+.1f}% significa que supervisores prestaram {change:+d} atendimentos a mais/menos
   - Indica maior/menor depend√™ncia dos agentes?

2. POSS√çVEIS CAUSAS OPERACIONAIS
   - Se aumentou: agentes com dificuldades ou casos mais complexos?
   - Se reduziu: agentes mais capacitados ou menor demanda?

3. IMPACTO NA PRODUTIVIDADE
   - Como isso afeta a efici√™ncia geral da contabilidade?
   - Supervisores sobrecarregados ou com capacidade ociosa?

4. RECOMENDA√á√ïES PR√ÅTICAS
   - A√ß√µes para otimizar a demanda de atendimentos
   - Como equilibrar autonomia vs suporte necess√°rio

REGRAS: Use APENAS os n√∫meros fornecidos. M√°ximo 120 palavras. Foque em produtividade da contabilidade.
"""
        return prompt.strip()
    
    @staticmethod
    def supervisor_performance_analysis(supervisor_data: Dict[str, Any], 
                                       weekly_data: Dict[str, Any],
                                       ranking_position: Optional[int] = None) -> str:
        """
        üë§ Prompt para an√°lise de performance de supervisor
        """
        supervisor = supervisor_data['supervisor']['name']
        current = supervisor_data['current_week']['total_tickets']
        previous = supervisor_data['previous_week']['total_tickets']
        change = supervisor_data['comparison']['absolute_change']
        change_percent = supervisor_data['comparison']['percent_change']
        
        agents = supervisor_data['current_week']['agents_performance']
        agents_count = len(agents)
        
        ranking_text = f"(#{ranking_position} no ranking)" if ranking_position else ""
        
        prompt = f"""
Voc√™ √© um gestor de contabilidade analisando produtividade individual.

DADOS REAIS DO SUPERVISOR {supervisor} {ranking_text}:
- Per√≠odo: {weekly_data['metadata']['current_week']['period_label']}
- Atendimentos prestados agora: {current}
- Atendimentos prestados antes: {previous}
- Varia√ß√£o real: {change:+d} atendimentos ({change_percent:+.1f}%)
- Agentes/funcion√°rios atendidos: {agents_count}

DETALHAMENTO POR AGENTE (quem mais solicitou atendimento):
"""
        
        # Adicionar dados dos agentes com foco em varia√ß√£o individual
        for i, agent in enumerate(agents[:5], 1):
            agent_name = agent['agent']['name']
            current_requests = agent['current_tickets']
            previous_requests = agent['previous_tickets']
            agent_change = agent['change']
            
            # Calcular porcentagem individual
            if previous_requests > 0:
                agent_percent = (agent_change / previous_requests) * 100
                prompt += f"‚Ä¢ {agent_name}: {current_requests} atendimentos (anterior: {previous_requests}) = {agent_change:+d} ({agent_percent:+.1f}%)\n"
            else:
                prompt += f"‚Ä¢ {agent_name}: {current_requests} atendimentos (anterior: {previous_requests}) = {agent_change:+d}\n"
        
        prompt += f"""
AN√ÅLISE INDIVIDUAL SOLICITADA:

1. PERFORMANCE DO SUPERVISOR {supervisor}
   - {current} atendimentos prestados representa sobrecarga ou demanda normal?
   - Varia√ß√£o de {change_percent:+.1f}% indica que agentes precisaram mais/menos suporte

2. AN√ÅLISE POR AGENTE (foque nos n√∫meros acima)
   - Qual agente mais solicitou atendimento e por qu√™?
   - Quais agentes tiveram maior varia√ß√£o percentual?
   - Algum agente demonstra necessidade de treinamento urgente?

3. IDENTIFICA√á√ÉO DE PADR√ïES
   - Agentes com aumento >30%: precisam capacita√ß√£o?
   - Agentes com redu√ß√£o >30%: est√£o mais aut√¥nomos ou ociosos?
   - Distribui√ß√£o equilibrada entre a equipe?

4. RECOMENDA√á√ïES ESPEC√çFICAS
   - Quais agentes treinar prioritariamente?
   - Como redistribuir demanda entre agentes?
   - A√ß√µes para pr√≥xima semana

REGRAS: Use APENAS os n√∫meros reais fornecidos. Cite nomes dos agentes. M√°ximo 110 palavras.
"""
        return prompt.strip()
    
    @staticmethod
    def strategic_recommendations(weekly_data: Dict[str, Any]) -> str:
        """
        üéØ Prompt para recomenda√ß√µes estrat√©gicas
        """
        supervisors = weekly_data['supervisors_data']
        global_stats = weekly_data['global_stats']
        
        # An√°lise dos supervisores
        total_supervisors = len(supervisors)
        overloaded = [s for s in supervisors if s['current_week']['total_tickets'] >= 50]
        high_demand_increase = [s for s in supervisors if s['comparison']['percent_change'] >= 25]
        demand_decrease = [s for s in supervisors if s['comparison']['percent_change'] <= -25]
        
        # Top supervisor por volume
        top_supervisor = max(supervisors, key=lambda x: x['current_week']['total_tickets']) if supervisors else None
        
        prompt = f"""
Voc√™ √© diretor de contabilidade preparando relat√≥rio para diretoria.

DADOS EXECUTIVOS REAIS:
- Per√≠odo: {weekly_data['metadata']['current_week']['period_label']}
- Total de atendimentos prestados por supervisores: {global_stats['current_week']['total_tickets']}
- Varia√ß√£o geral: {global_stats['comparison']['absolute_change']:+d} ({global_stats['comparison']['percent_change']:+.1f}%)
- Supervisores monitorados: {total_supervisors}

DISTRIBUI√á√ÉO DE CARGA ATUAL:
- Supervisores com alta demanda (‚â•50 atendimentos): {len(overloaded)}
- Supervisores com aumento significativo (+25%): {len(high_demand_increase)}
- Supervisores com redu√ß√£o significativa (-25%): {len(demand_decrease)}
"""
        
        if top_supervisor:
            top_change = top_supervisor['comparison']['absolute_change']
            top_percent = top_supervisor['comparison']['percent_change']
            prompt += f"‚Ä¢ Maior volume: {top_supervisor['supervisor']['name']} prestou {top_supervisor['current_week']['total_tickets']} atendimentos ({top_change:+d}, {top_percent:+.1f}%)\n"
        
        prompt += f"""
RECOMENDA√á√ïES ESTRAT√âGICAS PARA DIRETORIA:

1. GEST√ÉO DE PRODUTIVIDADE
   - Como balancear demanda de atendimentos entre supervisores?
   - Redistribui√ß√£o de agentes entre equipes sobrecarregadas?

2. CAPACITA√á√ÉO URGENTE
   - Agentes que mais demandam atendimento precisam treinamento?
   - Temas t√©cnicos que geram mais solicita√ß√µes de suporte?

3. OTIMIZA√á√ÉO OPERACIONAL
   - Como reduzir depend√™ncia dos agentes nos supervisores?
   - Ferramentas para aumentar autonomia dos funcion√°rios?

4. MONITORAMENTO DE EFICI√äNCIA
   - KPIs para detectar sobrecarga de supervisores precocemente?
   - M√©tricas de evolu√ß√£o da autonomia dos agentes?

5. PLANEJAMENTO DE RECURSOS
   - Necessidade de contrata√ß√£o ou redistribui√ß√£o?
   - Investimento em treinamento vs contrata√ß√£o de pessoal?

REGRAS: Foque em decis√µes executivas baseadas nos n√∫meros reais. M√°ximo 140 palavras.
"""
        return prompt.strip()
    
    @staticmethod
    def executive_summary(weekly_data: Dict[str, Any], 
                         global_analysis: Dict[str, Any],
                         supervisors_analysis: List[Dict[str, Any]]) -> str:
        """
        üìã Prompt para resumo executivo
        """
        period = weekly_data['metadata']['current_week']['period_label']
        total_tickets = weekly_data['global_stats']['current_week']['total_tickets']
        change = weekly_data['global_stats']['comparison']['absolute_change']
        change_percent = weekly_data['global_stats']['comparison']['percent_change']
        
        # An√°lise dos supervisores
        if supervisors_analysis:
            top_performer = max(supervisors_analysis, key=lambda x: x['key_metrics']['current_tickets'])
            high_variance = [s for s in supervisors_analysis if 
                           abs(s['key_metrics']['change_percent']) >= 30]
        else:
            top_performer = None
            high_variance = []
        
        prompt = f"""
Voc√™ √© CEO/diretor apresentando resultados para conselho administrativo.

RESUMO EXECUTIVO - PRODUTIVIDADE CONT√ÅBIL ({period}):

N√öMEROS PRINCIPAIS:
- Total de atendimentos prestados: {total_tickets}
- Varia√ß√£o operacional: {change:+d} ({change_percent:+.1f}%)
- Supervisores monitorados: {len(supervisors_analysis)}
- Situa√ß√µes que requerem aten√ß√£o: {len(high_variance)}
"""
        
        if top_performer:
            prompt += f"‚Ä¢ Supervisor com maior demanda: {top_performer['supervisor_name']} ({top_performer['key_metrics']['current_tickets']} atendimentos)\n"
        
        prompt += f"""
APRESENTA√á√ÉO PARA CONSELHO:

1. SITUA√á√ÉO OPERACIONAL
   - Status da produtividade na contabilidade
   - Efici√™ncia dos supervisores vs demanda dos agentes

2. PONTOS CR√çTICOS
   - Supervisores sobrecarregados que impactam produtividade
   - Agentes com alta depend√™ncia (precisam desenvolvimento urgente)

3. TEND√äNCIAS OBSERVADAS
   - Padr√µes na demanda por suporte t√©cnico
   - Evolu√ß√£o da autonomia dos funcion√°rios

4. DECIS√ïES ESTRAT√âGICAS
   - Investimentos necess√°rios em capacita√ß√£o
   - Necessidade de contrata√ß√£o ou redistribui√ß√£o

5. METAS PR√ìXIMO PER√çODO
   - Objetivos de redu√ß√£o da depend√™ncia
   - KPIs para monitorar efici√™ncia

REGRAS: Linguagem executiva para conselho. Use apenas n√∫meros reais. M√°ximo 120 palavras.
"""
        return prompt.strip()
    
    @staticmethod
    def agent_workload_analysis(agents_data: List[Dict[str, Any]], 
                               supervisor_name: str) -> str:
        """
        üë• Prompt para an√°lise detalhada dos agentes
        """
        if not agents_data:
            return "Nenhum atendimento registrado para agentes."
        
        total_tickets = sum(agent['current_tickets'] for agent in agents_data)
        
        prompt = f"""
Voc√™ √© coordenador de RH analisando produtividade individual dos agentes.

AN√ÅLISE DA EQUIPE DO SUPERVISOR {supervisor_name}:
- Total de agentes: {len(agents_data)}
- Total de atendimentos solicitados: {total_tickets}

PERFORMANCE INDIVIDUAL (compara√ß√£o semanal):
"""
        
        for agent in agents_data:
            name = agent['agent']['name']
            current = agent['current_tickets']
            previous = agent['previous_tickets']
            change = agent.get('change', 0)
            
            if previous > 0:
                percent_change = (change / previous) * 100
                prompt += f"‚Ä¢ {name}: {current} atendimentos (anterior: {previous}) = {change:+d} ({percent_change:+.1f}%)\n"
            else:
                prompt += f"‚Ä¢ {name}: {current} atendimentos (anterior: {previous}) = {change:+d}\n"
        
        prompt += f"""
AN√ÅLISE INDIVIDUAL SOLICITADA:

1. IDENTIFICA√á√ÉO DE NECESSIDADES
   - Quais agentes tiveram maior aumento percentual (precisam treinamento)?
   - Quais agentes tiveram redu√ß√£o significativa (mais aut√¥nomos ou ociosos)?

2. DISTRIBUI√á√ÉO DE PRODUTIVIDADE
   - A demanda est√° concentrada em poucos agentes?
   - Algum agente demonstra sobrecarga de trabalho?

3. OPORTUNIDADES DE DESENVOLVIMENTO
   - Agentes prontos para assumir casos mais complexos?
   - Necessidades espec√≠ficas de capacita√ß√£o t√©cnica?

4. RECOMENDA√á√ïES PR√ÅTICAS
   - Redistribui√ß√£o de responsabilidades entre agentes?
   - Plano de treinamento individualizado?

REGRAS: Cite nomes dos agentes nos insights. Use n√∫meros reais. M√°ximo 90 palavras.
"""
        return prompt.strip()
    
    @staticmethod
    def anomaly_detection(supervisor_data: Dict[str, Any], 
                         historical_context: Optional[Dict] = None) -> str:
        """
        üîç Prompt para detec√ß√£o de anomalias
        """
        supervisor = supervisor_data['supervisor']['name']
        change_percent = supervisor_data['comparison']['percent_change']
        current_tickets = supervisor_data['current_week']['total_tickets']
        agents = supervisor_data['current_week']['agents_performance']
        
        # Identificar anomalias reais
        anomalies = []
        
        if abs(change_percent) >= 60:
            anomalies.append(f"Supervisor {supervisor}: varia√ß√£o extrema de {change_percent:+.1f}% nos atendimentos")
        
        if current_tickets >= 60:
            anomalies.append(f"Supervisor {supervisor}: volume muito alto ({current_tickets} atendimentos)")
        
        for agent in agents:
            agent_change_percent = (agent['change'] / agent['previous_tickets'] * 100) if agent['previous_tickets'] > 0 else 0
            if abs(agent_change_percent) >= 100:
                anomalies.append(f"Agente {agent['agent']['name']}: varia√ß√£o de {agent_change_percent:+.1f}% nos atendimentos")
            if agent['current_tickets'] >= 25:
                anomalies.append(f"Agente {agent['agent']['name']}: {agent['current_tickets']} atendimentos (poss√≠vel sobrecarga)")
        
        prompt = f"""
Voc√™ √© analista de qualidade investigando padr√µes at√≠picos na produtividade.

ANOMALIAS DETECTADAS: {len(anomalies)}
"""
        
        for i, anomaly in enumerate(anomalies, 1):
            prompt += f"{i}. {anomaly}\n"
        
        prompt += f"""
INVESTIGA√á√ÉO NECESS√ÅRIA:

1. CAUSAS PROV√ÅVEIS
   - Picos de demanda de clientes espec√≠ficos?
   - Agentes enfrentando dificuldades t√©cnicas incomuns?
   - Mudan√ßas nos processos que afetaram produtividade?

2. IMPACTO OPERACIONAL
   - Risco de burnout ou sobrecarga?
   - Qualidade dos atendimentos comprometida?
   - Gargalos na opera√ß√£o?

3. A√á√ïES CORRETIVAS IMEDIATAS
   - Redistribui√ß√£o emergencial de carga?
   - Suporte adicional urgente?
   - Pausar novos casos complexos?

4. PREVEN√á√ÉO FUTURA
   - Monitoramento mais frequente?
   - Ajustes nos processos de distribui√ß√£o?
   - Treinamentos preventivos?

REGRAS: Foque em causas operacionais reais. M√°ximo 100 palavras.
"""
        return prompt.strip()
    
    @staticmethod
    def custom_insight_prompt(context: str, data_summary: str, question: str) -> str:
        """
        üé® Prompt personalizado para insights espec√≠ficos
        """
        prompt = f"""
Voc√™ √© consultor de produtividade em contabilidade.

CONTEXTO: {context}
DADOS: {data_summary}
PERGUNTA: {question}

AN√ÅLISE: Resposta baseada em n√∫meros reais, m√°ximo 70 palavras, foque em produtividade.
"""
        return prompt.strip()


# Fun√ß√µes de conveni√™ncia para uso direto
def get_global_analysis_prompt(global_stats: Dict[str, Any], weekly_data: Dict[str, Any]) -> str:
    """üîß Fun√ß√£o utilit√°ria para prompt de an√°lise global"""
    return PromptBuilder.global_trend_analysis(global_stats, weekly_data)


def get_supervisor_analysis_prompt(supervisor_data: Dict[str, Any], weekly_data: Dict[str, Any], ranking: Optional[int] = None) -> str:
    """üîß Fun√ß√£o utilit√°ria para prompt de an√°lise de supervisor"""
    return PromptBuilder.supervisor_performance_analysis(supervisor_data, weekly_data, ranking)


def get_strategic_prompt(weekly_data: Dict[str, Any]) -> str:
    """üîß Fun√ß√£o utilit√°ria para prompt estrat√©gico"""
    return PromptBuilder.strategic_recommendations(weekly_data)